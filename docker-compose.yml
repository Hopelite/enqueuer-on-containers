version: '3.4'

services:
  enqueuer.queueing.api:
    image: ${DOCKER_REGISTRY-}enqueuerqueueingapi
    build:
      context: .
      dockerfile: src/Enqueuer.Queueing.API/Dockerfile
    environment:
      - ConnectionStrings__QueueingDB=Server=sqlserver;Database=myDatabase;User Id=sa;Password=${ENQUEUER_QUEUEING_DATABASE_PASSWORD};TrustServerCertificate=true;
      - ConnectionStrings__EventBus=amqp://guest:guest@eventbus:5672
    depends_on:
      - sqlserver
      - eventbus
  
  eventbus:
    image: rabbitmq:management-alpine
    ports:
      - "5672:5672" # AMQP protocol port
      - "15672:15672" # Management interface port

  # TODO: replace with non-containerized database    
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${ENQUEUER_QUEUEING_DATABASE_PASSWORD}
    ports:
      - "1433:1433"

  enqueuer.telegram.notifications:
    image: ${DOCKER_REGISTRY-}enqueuertelegramnotifications
    build:
      context: .
      dockerfile: src/Enqueuer.Telegram.Notifications/Dockerfile
    environment:
      - ConnectionStrings__EventBus=amqp://guest:guest@eventbus:5672
      - ConnectionStrings__NotificationsDB=Data Source=/data/NotificationsDB.db
      - TelegramClient__AccessToken=${ENQUEUER_TELEGRAM_BOT_ACCESS_TOKEN}
    depends_on:
      - enqueuer.queueing.api
      - eventbus
    volumes:
      - C:/Users/vkurd/DATA:/data

  enqueuer.telegram.bff:
    image: ${DOCKER_REGISTRY-}enqueuertelegrambff
    build:
      context: .
      dockerfile: src/Enqueuer.Telegram.BFF/Dockerfile
    environment:
      - ConnectionStrings__QueueingAPI=http://enqueuer.queueing.api:8080
      - TelegramClient__AccessToken=${ENQUEUER_TELEGRAM_BOT_ACCESS_TOKEN}
    depends_on:
      - enqueuer.queueing.api

volumes:
  notificationsdb:
